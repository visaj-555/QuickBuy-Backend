<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Manager Elite Pro</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #0d6efd;
        --secondary: #20c997;
        --danger: #dc3545;
        --warning: #ffc107;
        --background: #eef2f7;
        --card-bg: #ffffff;
        --text: #1a1d24;
        --text-muted: #677788;
        --border: #dee2e6;
        --shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
        --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: var(--background);
        color: var(--text);
        line-height: 1.6;
        min-height: 100vh;
        overflow-x: hidden;
      }

      .container {
        max-width: 1500px;
        margin: 0 auto;
        padding: 2.5rem;
      }

      .header {
        background: linear-gradient(135deg, var(--card-bg), #f8f9fa);
        padding: 1.5rem 2rem;
        border-radius: 16px;
        box-shadow: var(--shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2.5rem;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      h1 {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--primary);
        letter-spacing: -0.5px;
      }

      .search-bar {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .search-input {
        padding: 0.75rem 1.25rem;
        border: 1px solid var(--border);
        border-radius: 10px;
        width: 320px;
        font-size: 1rem;
        background: white;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 8px rgba(13, 110, 253, 0.2);
        outline: none;
      }

      .main-content {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 2.5rem;
      }

      .product-list {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: var(--shadow);
        min-height: calc(100vh - 200px);
        overflow-y: auto;
        position: relative;
      }

      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 2rem;
      }

      .product-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .product-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-hover);
      }

      .image-gallery {
        position: relative;
        height: 220px;
        margin-bottom: 1.5rem;
        border-radius: 10px;
        overflow: hidden;
        background: #f8f9fa;
      }

      .main-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
      }

      .product-card:hover .main-image {
        transform: scale(1.05);
      }

      .image-thumbs {
        position: absolute;
        bottom: 12px;
        left: 12px;
        display: flex;
        gap: 8px;
        padding: 4px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
      }

      .thumb {
        width: 45px;
        height: 45px;
        object-fit: cover;
        border-radius: 6px;
        border: 2px solid white;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .thumb:hover {
        transform: scale(1.1);
        border-color: var(--primary);
      }

      .product-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        line-height: 1.3;
      }

      .product-price {
        color: var(--secondary);
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .product-meta {
        color: var(--text-muted);
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
      }

      .colors-list,
      .highlights-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }

      .color-chip,
      .highlight-chip {
        padding: 0.3rem 0.9rem;
        border-radius: 20px;
        font-size: 0.85rem;
        background: #e9ecef;
        color: var(--text);
      }

      .color-chip {
        background: linear-gradient(135deg, #e9ecef, #f8f9fa);
      }

      .action-buttons {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      .btn {
        padding: 0.6rem 1.25rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }
      .btn:hover {
        transform: translateY(-2px);
      }
      .btn:active {
        transform: translateY(1px);
      }

      .form-panel {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: var(--shadow);
        position: sticky;
        top: 2.5rem;
        height: calc(100vh - 200px);
        overflow-y: auto;
        transition: all 0.3s ease;
      }

      .form-title {
        font-size: 1.6rem;
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 1.75rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--text);
      }

      input,
      select,
      .multi-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: all 0.3s ease;
      }

      input:focus,
      select:focus,
      .multi-select:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 8px rgba(13, 110, 253, 0.2);
        outline: none;
      }

      .multi-select {
        min-height: 80px;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.5rem;
        align-content: flex-start;
      }

      .tag {
        background: #e9ecef;
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .remove-tag {
        cursor: pointer;
        color: var(--danger);
        font-weight: 600;
        font-size: 1.1rem;
      }

      .form-footer {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        max-width: 520px;
        width: 90%;
        box-shadow: var(--shadow);
        animation: modalIn 0.3s ease-out;
      }

      .loader {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
      }

      @media (max-width: 1200px) {
        .main-content {
          grid-template-columns: 1fr;
        }
        .form-panel {
          position: relative;
          height: auto;
        }
      }

      @keyframes modalIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Product Manager Elite Pro</h1>
        <div class="search-bar">
          <input
            type="text"
            class="search-input"
            placeholder="Search products..."
            id="searchInput"
          />
          <button class="btn btn-primary" onclick="addNewProduct()">
            Add Product
          </button>
        </div>
      </div>

      <div class="main-content">
        <div class="product-list" id="productList">
          <div id="productGrid" class="product-grid"></div>
        </div>

        <div class="form-panel">
          <h2 class="form-title" id="formTitle">Add New Product</h2>
          <form id="productForm" enctype="multipart/form-data">
            <div class="form-group">
              <label>Product Name *</label>
              <input name="productName" required />
            </div>
            <div class="form-group">
              <label>Final Price *</label>
              <input
                name="finalProductPrice"
                type="number"
                step="0.01"
                required
              />
            </div>
            <div class="form-group">
              <label>Original Price *</label>
              <input name="productPrice" type="number" step="0.01" required />
            </div>
            <div class="form-group">
              <label>Rating (0-5) *</label>
              <input
                name="rating"
                type="number"
                min="0"
                max="5"
                step="0.1"
                required
              />
            </div>
            <div class="form-group">
              <label>Brand *</label>
              <input name="productBrand" required />
            </div>
            <div class="form-group">
              <label>Category *</label>
              <select name="category" required>
                <option value="">Select Category</option>
                <option value="mobile">Mobile</option>
                <option value="laptop">Laptop</option>
                <option value="accessory">Accessory</option>
                <option value="smartWatch">Smart Watch</option>
                <option value="tv">TV</option>
                <option value="tablet">Tablet</option>
              </select>
            </div>
            <div class="form-group">
              <label>Colors *</label>
              <div class="multi-select" id="colorsSelect"></div>
              <input
                type="text"
                id="colorInput"
                placeholder="Add color and press Enter"
              />
            </div>
            <div class="form-group">
              <label>Highlights *</label>
              <div class="multi-select" id="highlightsSelect"></div>
              <input
                type="text"
                id="highlightInput"
                placeholder="Add highlight and press Enter"
              />
            </div>
            <div class="form-group">
              <label>Images *</label>
              <input type="file" name="productImages" multiple required />
            </div>
            <div class="form-footer">
              <button type="submit" class="btn btn-primary" id="submitBtn">
                Save Product
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="clearForm()"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal" id="deleteModal">
      <div class="modal-content">
        <h2>Confirm Deletion</h2>
        <p>
          Are you sure you want to delete "<span id="deleteProductName"></span
          >"?
        </p>
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem">
          <button class="btn btn-danger" id="confirmDelete">Delete</button>
          <button class="btn btn-secondary" onclick="closeModal()">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:4200";
      let editingProductId = null;
      let products = [];
      let colors = [];
      let highlights = [];

      const productList = document.getElementById("productList");
      const productGrid = document.getElementById("productGrid");
      const productForm = document.getElementById("productForm");
      const formTitle = document.getElementById("formTitle");
      const submitBtn = document.getElementById("submitBtn");
      const searchInput = document.getElementById("searchInput");
      const deleteModal = document.getElementById("deleteModal");
      const colorsSelect = document.getElementById("colorsSelect");
      const highlightsSelect = document.getElementById("highlightsSelect");
      const colorInput = document.getElementById("colorInput");
      const highlightInput = document.getElementById("highlightInput");

      fetchProducts();

      // Form submission
      productForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        e.stopPropagation(); // Prevent form submission from affecting scroll
        const scrollPosition = productList.scrollTop; // Store product list scroll position

        const formData = new FormData(productForm);
        formData.append("colors", JSON.stringify(colors));
        formData.append("highlights", JSON.stringify(highlights));

        const url = editingProductId
          ? `${API_BASE}/product/update/${editingProductId}`
          : `${API_BASE}/product/add`;
        const method = editingProductId ? "PATCH" : "POST";

        try {
          submitBtn.disabled = true;
          submitBtn.textContent = "Saving...";
          const res = await fetch(url, { method, body: formData });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Operation failed");

          if (editingProductId) {
            const index = products.findIndex((p) => p._id === editingProductId);
            products[index] = data.data;
          } else {
            products.unshift(data.data);
          }

          clearForm();
          renderProducts(products);
          showToast(editingProductId ? "Product updated!" : "Product added!");
          productList.scrollTop = scrollPosition; // Restore product list scroll position
        } catch (err) {
          showToast("Error: " + err.message, true);
          productList.scrollTop = scrollPosition; // Restore on error
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Save Product";
        }
      });

      // Fetch products
      async function fetchProducts() {
        try {
          productGrid.innerHTML =
            '<div class="loader">Loading products...</div>';
          const res = await fetch(`${API_BASE}/product/view`);
          const { data } = await res.json();
          products = data || [];
          renderProducts(products);
        } catch (err) {
          productGrid.innerHTML =
            '<div class="loader">Error loading products</div>';
        }
      }

      // Render products
      function renderProducts(productsToRender) {
        const scrollPosition = productList.scrollTop; // Store scroll position before render
        const filteredProducts = filterProducts(productsToRender);
        productGrid.innerHTML = "";
        if (!filteredProducts.length) {
          productGrid.innerHTML = '<div class="loader">No products found</div>';
          productList.scrollTop = scrollPosition; // Restore scroll position
          return;
        }

        filteredProducts.forEach((p) => {
          const card = document.createElement("div");
          card.className = "product-card";
          card.innerHTML = `
          <div class="image-gallery">
            <img src="${API_BASE}/${
            p.productImages[0]
          }" class="main-image" alt="${p.productName}">
            <div class="image-thumbs">
              ${p.productImages
                .map(
                  (img) => `
                <img src="${API_BASE}/${img}" class="thumb" onclick="changeImage(this, '${API_BASE}/${img}')">
              `
                )
                .join("")}
            </div>
          </div>
          <div class="product-title">${p.productName}</div>
          <div class="product-price">₹${p.finalProductPrice.toLocaleString()}</div>
          <div class="product-meta">
            Brand: ${p.productBrand}<br>
            Rating: ${p.rating}/5<br>
            Category: ${p.category}
          </div>
          <div class="colors-list">
            ${p.colors
              .map((color) => `<span class="color-chip">${color}</span>`)
              .join("")}
          </div>
          <div class="highlights-list">
            ${p.highlights
              .map(
                (highlight) =>
                  `<span class="highlight-chip">${highlight}</span>`
              )
              .join("")}
          </div>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="editProduct('${
              p._id
            }')">Edit</button>
            <button class="btn btn-danger" onclick="showDeleteModal('${
              p._id
            }', '${p.productName}')">Delete</button>
          </div>
        `;
          productGrid.appendChild(card);
        });
        productList.scrollTop = scrollPosition; // Restore scroll position after render
      }

      // Image gallery handler
      window.changeImage = (thumb, src) => {
        const gallery = thumb.closest(".image-gallery");
        gallery.querySelector(".main-image").src = src;
      };

      // Edit product
      function editProduct(id) {
        const scrollPosition = productList.scrollTop; // Store scroll position
        const product = products.find((p) => p._id === id);
        if (!product) return;

        editingProductId = id;
        formTitle.textContent = "Edit Product";
        productForm.productName.value = product.productName;
        productForm.finalProductPrice.value = product.finalProductPrice;
        productForm.productPrice.value = product.productPrice;
        productForm.rating.value = product.rating;
        productForm.productBrand.value = product.productBrand;
        productForm.category.value = product.category;
        colors = [...product.colors];
        highlights = [...product.highlights];
        renderTags();
        productList.scrollTop = scrollPosition; // Restore scroll position
        window.scrollTo({ top: 0, behavior: "smooth" }); // Scroll to form
      }

      // Add new product
      function addNewProduct() {
        const scrollPosition = productList.scrollTop; // Store scroll position
        clearForm();
        formTitle.textContent = "Add New Product";
        editingProductId = null;
        productList.scrollTop = scrollPosition; // Restore scroll position
        window.scrollTo({ top: 0, behavior: "smooth" }); // Scroll to form
      }

      // Clear form
      function clearForm() {
        const scrollPosition = productList.scrollTop; // Store scroll position
        productForm.reset();
        colors = [];
        highlights = [];
        renderTags();
        formTitle.textContent = "Add New Product";
        editingProductId = null;
        productList.scrollTop = scrollPosition; // Restore scroll position
      }

      // Tags management
      function renderTags() {
        const scrollPosition = productList.scrollTop; // Store scroll position
        colorsSelect.innerHTML = colors
          .map(
            (color) => `
        <div class="tag">${color} <span class="remove-tag" onclick="removeColor('${color}')">×</span></div>
      `
          )
          .join("");
        highlightsSelect.innerHTML = highlights
          .map(
            (highlight) => `
        <div class="tag">${highlight} <span class="remove-tag" onclick="removeHighlight('${highlight}')">×</span></div>
      `
          )
          .join("");
        productList.scrollTop = scrollPosition; // Restore scroll position
      }

      colorInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && colorInput.value.trim()) {
          const scrollPosition = productList.scrollTop; // Store scroll position
          colors.push(colorInput.value.trim());
          colorInput.value = "";
          renderTags();
          productList.scrollTop = scrollPosition; // Restore scroll position
        }
      });

      highlightInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && highlightInput.value.trim()) {
          const scrollPosition = productList.scrollTop; // Store scroll position
          highlights.push(highlightInput.value.trim());
          highlightInput.value = "";
          renderTags();
          productList.scrollTop = scrollPosition; // Restore scroll position
        }
      });

      window.removeColor = (color) => {
        const scrollPosition = productList.scrollTop; // Store scroll position
        colors = colors.filter((c) => c !== color);
        renderTags();
        productList.scrollTop = scrollPosition; // Restore scroll position
      };

      window.removeHighlight = (highlight) => {
        const scrollPosition = productList.scrollTop; // Store scroll position
        highlights = highlights.filter((h) => h !== highlight);
        renderTags();
        productList.scrollTop = scrollPosition; // Restore scroll position
      };

      // Search
      searchInput.addEventListener("input", (e) => {
        const scrollPosition = productList.scrollTop; // Store scroll position
        renderProducts(products);
        productList.scrollTop = scrollPosition; // Restore scroll position
      });

      function filterProducts(productsToFilter) {
        const search = searchInput.value.toLowerCase();
        return productsToFilter.filter(
          (p) =>
            p.productName.toLowerCase().includes(search) ||
            p.productBrand.toLowerCase().includes(search) ||
            p.category.toLowerCase().includes(search) ||
            p.colors.some((c) => c.toLowerCase().includes(search)) ||
            p.highlights.some((h) => h.toLowerCase().includes(search))
        );
      }

      // Delete modal
      function showDeleteModal(id, name) {
        const scrollPosition = productList.scrollTop; // Store scroll position
        document.getElementById("deleteProductName").textContent = name;
        deleteModal.style.display = "flex";
        document.getElementById("confirmDelete").onclick = async () => {
          try {
            const res = await fetch(`${API_BASE}/product/delete/${id}`, {
              method: "DELETE",
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || "Deletion failed");
            products = products.filter((p) => p._id !== id);
            renderProducts(products);
            showToast("Product deleted!");
            productList.scrollTop = scrollPosition; // Restore scroll position
          } catch (err) {
            showToast("Error: " + err.message, true);
            productList.scrollTop = scrollPosition; // Restore scroll position on error
          }
          closeModal();
        };
      }

      function closeModal() {
        deleteModal.style.display = "none";
      }

      // Toast
      function showToast(message, isError = false) {
        const toast = document.createElement("div");
        toast.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 1rem 2rem;
        background: ${isError ? "var(--danger)" : "var(--secondary)"};
        color: white;
        border-radius: 10px;
        box-shadow: var(--shadow);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideIn 0.3s ease-out;
      `;
        toast.innerHTML = `<span>${message}</span>`;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = "slideOut 0.3s ease-in";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Animation keyframes
      const styleSheet = document.createElement("style");
      styleSheet.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
      document.head.appendChild(styleSheet);
    </script>
  </body>
</html>
